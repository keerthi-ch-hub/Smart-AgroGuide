{% extends "base.html" %}
{% block content %}

<h2 class="text-2xl font-bold text-green-700 mb-4">AI Chatbot</h2>

<div class="bg-white p-6 rounded shadow">

    <!-- TEXT INPUT -->
    <input id="question"
           type="text"
           placeholder="Ask farming questions..."
           class="p-3 w-full border rounded" />

    <button id="askBtn"
            class="mt-4 bg-green-600 text-white px-4 py-2 rounded">
        Ask
    </button>


    <!-- AUDIO UPLOAD -->
    <div class="mt-6">
        <label class="block mb-2 font-semibold">Upload Audio (optional)</label>

        <input type="file" id="audioFile" accept=".mp3,.wav"
               class="p-2 border rounded w-3/4" />

        <button id="uploadBtn"
                class="bg-blue-600 text-white px-4 py-2 rounded ml-2">
            Upload
        </button>
    </div>


    <!-- RESPONSE BOX -->
    <div id="responseBox"
         class="mt-4 p-4 bg-blue-50 rounded hidden"></div>

</div>


<script>
// ==========================================================
// TEXT CHATBOT
// ==========================================================
async function sendText() {
    let question = document.getElementById("question").value.trim();

    if (!question) {
        alert("Please enter a question.");
        return;
    }

    const formData = new FormData();
    formData.append("message", question);

    try {
        const res = await fetch("/api/chat", {
            method: "POST",
            body: formData
        });

        if (!res.ok) {
            throw new Error("Server error");
        }

        const data = await res.json();

        document.getElementById("responseBox").classList.remove("hidden");
        document.getElementById("responseBox").innerHTML =
            `<b>Bot:</b> ${data.answer}`;

    } catch (err) {
        console.error(err);
        alert("Chatbot is still starting... try again in 1 second.");
    }
}

document.getElementById("askBtn").onclick = sendText;



// ==========================================================
// AUDIO CHATBOT
// ==========================================================
document.getElementById("uploadBtn").onclick = async () => {
    const file = document.getElementById("audioFile").files[0];

    if (!file) {
        alert("Please upload an audio file.");
        return;
    }

    const formData = new FormData();
    formData.append("audio", file);

    try {
        const res = await fetch("/api/audio-chat", {
            method: "POST",
            body: formData
        });

        if (!res.ok) {
            throw new Error("Audio server error");
        }

        const data = await res.json();

        document.getElementById("responseBox").classList.remove("hidden");
        document.getElementById("responseBox").innerHTML = `
            <b>Audio Transcript:</b> ${data.transcript} <br><br>
            <b>Bot:</b> ${data.answer}
        `;

    } catch (err) {
        console.error(err);
        alert("Audio processing failed. Try again.");
    }
};
</script>

{% endblock %}
