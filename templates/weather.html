{% extends "base.html" %}
{% block content %}

<h2 class="text-3xl font-extrabold text-green-700 mb-6">Weather Dashboard</h2>

<div class="bg-white p-6 rounded shadow">

    <!-- Input Section -->
    <div class="flex gap-4 items-center">
        <input id="city"
               type="text"
               placeholder="Enter city name"
               class="p-3 flex-1 border rounded" />

        <button id="getWeatherBtn"
                class="bg-blue-600 text-white px-6 py-3 rounded">
            Get Weather
        </button>
    </div>

    <!-- RESULTS AREA -->
    <div id="weatherSummary" class="mt-6"></div>

    <!-- GRAPHS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">

        <!-- Temperature Graph -->
        <div class="p-4 border rounded bg-gray-50">
            <h3 class="text-lg font-bold mb-2">Temperature (Â°C)</h3>
            <canvas id="tempChart" height="150"></canvas>
        </div>

        <!-- Humidity Graph -->
        <div class="p-4 border rounded bg-gray-50">
            <h3 class="text-lg font-bold mb-2">Humidity (%)</h3>
            <canvas id="humidityChart" height="150"></canvas>
        </div>

        <!-- Wind Speed Graph -->
        <div class="p-4 border rounded bg-gray-50">
            <h3 class="text-lg font-bold mb-2">Wind Speed (m/s)</h3>
            <canvas id="windChart" height="150"></canvas>
        </div>

    </div>

    <!-- 24-Hour Table -->
    <div class="mt-10">
        <h3 class="text-xl font-bold mb-2">Next 24 Hours (Detailed)</h3>
        <table class="w-full border mt-2">
            <thead class="bg-green-100">
                <tr>
                    <th class="border p-2">Time</th>
                    <th class="border p-2">Temp (Â°C)</th>
                    <th class="border p-2">Humidity</th>
                    <th class="border p-2">Wind</th>
                    <th class="border p-2">Condition</th>
                </tr>
            </thead>
            <tbody id="hourlyTable"></tbody>
        </table>
    </div>

    <!-- Advisory -->
    <div id="advisoryBox" class="mt-10 p-5 bg-yellow-100 rounded border"></div>

</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
let tempChart, humidityChart, windChart;

document.getElementById("getWeatherBtn").onclick = fetchWeather;

// ==============================================
// FETCH WEATHER
// ==============================================
async function fetchWeather() {
    let city = document.getElementById("city").value.trim();
    if (!city) return alert("Enter city name!");

    const res = await fetch("/api/weather", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ city })
    });

    const data = await res.json();

    if (!data.list) {
        alert("City not found.");
        return;
    }

    const nextHours = data.list.slice(0, 8); // Next 24 hrs (8 x 3hrs)

    const times = nextHours.map(i =>
        new Date(i.dt * 1000).toLocaleTimeString([], { hour: "2-digit" })
    );
    const temps = nextHours.map(i => i.main.temp);
    const humidity = nextHours.map(i => i.main.humidity);
    const wind = nextHours.map(i => i.wind.speed);

    drawTempChart(times, temps);
    drawHumidityChart(times, humidity);
    drawWindChart(times, wind);

    renderTable(nextHours);
    showSummary(data.city.name, temps[0], nextHours[0].weather[0]);
    showAdvisory(temps[0], humidity[0], wind[0]);
}


// ==============================================
// SUMMARY BOX
// ==============================================
function showSummary(city, temp, weather) {
    document.getElementById("weatherSummary").innerHTML = `
        <div class="p-4 bg-blue-50 rounded flex items-center gap-4">
            <img src="http://openweathermap.org/img/w/${weather.icon}.png" />
            <div>
                <h3 class="text-xl font-bold">${city}</h3>
                <p class="text-lg">${temp}Â°C â€” ${weather.description}</p>
            </div>
        </div>
    `;
}


// ==============================================
// DRAW CHARTS
// ==============================================
function drawTempChart(labels, values) {
    if (tempChart) tempChart.destroy();
    tempChart = new Chart(document.getElementById("tempChart"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Temperature Â°C",
                data: values,
                borderColor: "red",
                borderWidth: 3,
                tension: 0.3
            }]
        }
    });
}

function drawHumidityChart(labels, values) {
    if (humidityChart) humidityChart.destroy();
    humidityChart = new Chart(document.getElementById("humidityChart"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Humidity %",
                data: values,
                borderColor: "blue",
                borderWidth: 3,
                tension: 0.3
            }]
        }
    });
}

function drawWindChart(labels, values) {
    if (windChart) windChart.destroy();
    windChart = new Chart(document.getElementById("windChart"), {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "Wind Speed (m/s)",
                data: values,
                borderColor: "green",
                borderWidth: 3,
                tension: 0.3
            }]
        }
    });
}


// ==============================================
// 24-HOUR TABLE
// ==============================================
function renderTable(list) {
    let html = "";
    list.forEach(i => {
        html += `
            <tr>
                <td class="border p-2">${new Date(i.dt * 1000).toLocaleString()}</td>
                <td class="border p-2">${i.main.temp}</td>
                <td class="border p-2">${i.main.humidity}%</td>
                <td class="border p-2">${i.wind.speed} m/s</td>
                <td class="border p-2">${i.weather[0].description}</td>
            </tr>
        `;
    });

    document.getElementById("hourlyTable").innerHTML = html;
}


// ==============================================
// AGRICULTURE ADVISORY
// ==============================================
function showAdvisory(temp, humidity, wind) {
    let msg = "";

    if (temp > 35) msg += "ðŸ”¥ High temperature! Irrigate crops frequently.<br>";
    if (temp < 15) msg += "â„ Cool weather! Protect sensitive plants.<br>";
    if (humidity > 80) msg += "ðŸ’§ High humidity â€” risk of fungal diseases.<br>";
    if (wind > 10) msg += "ðŸŒ¬ Strong wind! Secure greenhouse and nets.<br>";

    if (!msg) msg = "ðŸŒ¿ Weather conditions are normal for agriculture.";

    document.getElementById("advisoryBox").innerHTML = `
        <h3 class="text-xl font-bold mb-2">Agriculture Advisory</h3>
        <p>${msg}</p>
    `;
}

</script>

{% endblock %}
